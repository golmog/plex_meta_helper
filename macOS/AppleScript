-- 이 핸들러는 "plexplay://..." 또는 "plexfolder://..." 형태의 URL을 처리합니다.
on open location this_URL

    -- URL에서 "plexplay://" 또는 "plexfolder://" 부분을 제거합니다.
    if this_URL starts with "plexplay://" then
        set processed_URL to text 9 thru -1 of this_URL
        set isFolder to false
    else if this_URL starts with "plexfolder://" then
        set processed_URL to text 12 thru -1 of this_URL
        set isFolder to true
    else
        display dialog "알 수 없는 URL 스킴입니다." with icon stop
        return
    end if

    -- URL 디코딩을 위한 셸 스크립트 호출
    set decoded_path to do shell script "python3 -c 'import sys, urllib.parse; print(urllib.parse.unquote(sys.argv[1]))' " & quoted form of processed_URL

    -- macOS는 경로를 POSIX 형식(슬래시 사용)으로 처리하므로, Finder에 전달
    try
        -- POSIX 경로를 Finder가 이해할 수 있는 형태로 변환
        set theItem to POSIX file decoded_path as alias

        -- 파일/폴더 존재 여부 확인
        tell application "Finder"
            if not (exists theItem) then
                error "경로를 찾을 수 없습니다."
            end if
        end tell
        
        -- 기본 앱으로 열기
        tell application "Finder"
            open theItem
        end tell

    on error
        display dialog "파일 또는 폴더를 열 수 없습니다:\n" & decoded_path with icon stop
    end try

end open location
