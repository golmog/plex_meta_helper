-- 이 핸들러는 "plexplay://...", "plexstream://..." 또는 "plexfolder://..." 형태의 URL을 처리합니다.
on open location this_url
	-- URL 파싱 (프로토콜 분리)
	set AppleScript's text item delimiters to "://"
	set url_parts to text items of this_url
	set protocol to item 1 of url_parts
	set raw_data to item 2 of url_parts
	set AppleScript's text item delimiters to ""
	
	-- URL 디코딩 (Python3 이용)
	set decode_script to "python3 -c \"import urllib.parse, sys; print(urllib.parse.unquote(sys.argv[1]))\" " & quoted form of raw_data
	set decoded_data to do shell script decode_script
	
	if protocol is "plexplay" then
		-- [로컬 재생] 기본 플레이어로 열기
		do shell script "open " & quoted form of decoded_data
		
	else if protocol is "plexfolder" then
		-- [폴더 열기] Finder에서 파일 선택
		do shell script "open -R " & quoted form of decoded_data
		
	else if protocol is "plexstream" then
		-- [스트리밍] IINA 플레이어로 열기 (자막 처리 포함)
		set AppleScript's text item delimiters to "|"
		set stream_parts to text items of decoded_data
		set vid_url to item 1 of stream_parts
		set sub_url to ""
		if (count of stream_parts) > 1 then
			set sub_url to item 2 of stream_parts
		end if
		set AppleScript's text item delimiters to ""
		
		-- IINA 실행 (mpv 기반이라 명령줄 지원)
		if sub_url is not "" then
			-- IINA는 URL 스킴(iina://)을 지원하지만 자막 동시 로드는 터미널 명령이 확실함
			do shell script "/Applications/IINA.app/Contents/MacOS/iina --mpv-sub-file=" & quoted form of sub_url & " " & quoted form of vid_url & " > /dev/null 2>&1 &"
		else
			do shell script "open -a IINA " & quoted form of vid_url
		end if
	end if
end open location
